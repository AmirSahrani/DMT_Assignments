from torch.utils.data import Dataset
import pandas as pd
import numpy as np
import torch
import pprint


def get_user_data(df, row, window_user, window_other):
    '''
    Get the rows before the current row for every user, the context length for the current user and the other users can be specified.
    WARNING: This function assumes that the data is sorted by time, and is meant to be used in a pandas apply function.

    :param df: The dataframe containing the dataframe
    :param row: The current row
    :param window_user: The context length for the current user
    :param window_other: The context length for the other users

    :return: The features and labels for the current user and the other users
    '''
    features = []
    user = row['id']
    time = row['time']

    user_data = df[df['id'] == user]
    user_data = user_data[user_data['time'] <= time]
    others_data = df[df['id'] != user]
    others_data = others_data[others_data['time'] <= time]

    if len(user_data) > window_user and len(others_data) > window_other:
        user_data = user_data.iloc[window_user:]

        # print(user_data.iloc[:, :-1].values)
        features = user_data.iloc[:, :-1].values.flatten()
        label = user_data.iloc[-1, -1]

        others_data = others_data.iloc[:window_other]

        # print(others_data.iloc[:, :-1].values)
        features = np.concatenate([features, others_data.iloc[:, :-1].values.flatten()])

        return np.array(features), np.array(label)
    else:
        return np.array([]), np.array([])


def test_user_data():
    df = pd.DataFrame({
        'id' = [1, 1, 3, 1, 2, 2, 2, 3, ,3],
        'time' = [1, 2, 1, 3, 1, 2, 3, 1, 2, 3],
        'feature1' = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
        'feature2' = [11, 12, 13, 14, 15, 16, 17, 18, 19, 20],
        'label' = [0, 1, 0, 1, 0, 1, 0, 1, 0, 1]
    })

    features, labels = zip(*df.apply(lambda x: get_user_data(df, x, 2, 2), axis=1))
    pprint.pprint(features)
    pprint.pprint(labels)


test_user_data()


class MoodDataset(Dataset):
    def __init__(self, csv_file):
        self.data = pd.read_csv(csv_file)

        features = self.data.apply(lambda x: get_user_data(self.data, x, 5, 5), axis=1)
        self.features, self.labels = zip(*features)
        print([f.item() for f in self.labels])
        # self.features = np.array([f for f in self.features if len(f) > 0])
        # self.labels = np.array([l for l in self.labels if l in [0,1]])

    def __len__(self):
        return len(self.data)

    def __getitem__(self, index):
        return torch.tensor(self.features[index], dtype=torch.float), torch.tensor(self.labels[index], dtype=torch.long)


# MoodDataset('data/preprocessed/toy_data.csv')
